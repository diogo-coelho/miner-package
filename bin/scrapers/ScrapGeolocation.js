"use strict";var __awaiter=this&&this.__awaiter||function(e,n,c,l){return new(c=c||Promise)(function(r,t){function i(e){try{a(l.next(e))}catch(e){t(e)}}function o(e){try{a(l.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?r(e.value):((t=e.value)instanceof c?t:new c(function(e){e(t)})).then(i,o)}a((l=l.apply(e,n||[])).next())})},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const BrowserLauncher_1=__importDefault(require("../utils/BrowserLauncher")),ErrorScrapGeolocation_1=__importDefault(require("./../errors/ErrorScrapGeolocation"));class ScrapGeolocation{init(t,r){return __awaiter(this,void 0,void 0,function*(){try{this._companyName=t,this._country=r,this._browserLauncher=new BrowserLauncher_1.default;const e=yield this._browserLauncher.browserPromise.then(e=>e.defaultBrowserContext());yield e.overridePermissions("https://www.google.com.br/maps",["geolocation"]),this._page=yield e.newPage()}catch(e){throw new ErrorScrapGeolocation_1.default(e)}})}openPage(){return __awaiter(this,void 0,void 0,function*(){try{return yield this._page.setGeolocation({latitude:this._country.lat,longitude:this._country.lng,accuracy:100}),yield this._page.setUserAgent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36"),yield this._page.goto("https://www.google.com.br/maps/search/@"+this._country.lat+","+this._country.lng+",12z/",{timeout:12e4,waitUntil:"networkidle2"}),!0}catch(e){throw new ErrorScrapGeolocation_1.default(e)}})}searchCompanies(){return __awaiter(this,void 0,void 0,function*(){try{yield this.insertCountryData(),yield this._page.waitForTimeout(2e3),yield this.insertCompanyData();var e=yield this.companiesList();if(e)return e;{const t=[];return t.push(yield this.getCompanyLink()),t}}catch(e){if(e.toString().indexOf("TimeoutError"))throw new ErrorScrapGeolocation_1.default("Timeout connection exceed");throw new ErrorScrapGeolocation_1.default(e)}})}insertCountryData(){return __awaiter(this,void 0,void 0,function*(){try{return yield this._page.waitForSelector("#searchboxinput",{timeout:1e4}),yield this._page.click("#searchboxinput"),yield this._page.keyboard.type(`${this._country.code} `),yield this._page.click("#searchboxinput"),yield this._page.waitForResponse(e=>200===e.status()),yield this._page.waitForSelector("#searchbox-searchbutton",{timeout:1e4}),!0}catch(e){throw new ErrorScrapGeolocation_1.default(e)}})}insertCompanyData(){return __awaiter(this,void 0,void 0,function*(){try{return yield this._page.waitForSelector("#searchboxinput",{timeout:1e4}),yield this._page.click("#searchboxinput"),yield this._page.keyboard.type(`${this._companyName} `),yield this._page.click("#searchbox-searchbutton"),yield this._page.waitForResponse(e=>200===e.status()),yield this._page.waitForSelector("h1",{timeout:1e4}),!0}catch(e){throw new ErrorScrapGeolocation_1.default(e)}})}companiesList(){return __awaiter(this,void 0,void 0,function*(){return yield this._page.waitForSelector(".m6QErb.DxyBCb.kA9KIf.dS8AEf.ecceSd",{timeout:1e4}).then(()=>__awaiter(this,void 0,void 0,function*(){return yield this._page.evaluate(()=>{const e=[];for(const t of document.querySelectorAll(".Nv2PK.tH5CWc.THOPZb"))e.push({title:t.querySelector(".fontHeadlineSmall > span").textContent.replace(/\r?\n|\r/g,"").trim(),href:t.querySelector("a").href});return e})})).catch(e=>null)})}getCompanyLink(){return __awaiter(this,void 0,void 0,function*(){return yield this._page.waitForSelector("h1",{timeout:1e4}).then(()=>__awaiter(this,void 0,void 0,function*(){return yield this._page.evaluate(()=>{return{title:document.querySelector("h1").textContent.replace(/\r?\n|\r/g,"").trim(),href:window.location.href}})})).catch(e=>{throw new ErrorScrapGeolocation_1.default(e)})})}getCompanyData(e){return __awaiter(this,void 0,void 0,function*(){return yield this.openCompany(e),yield this.companyInfo()})}openCompany(e){return __awaiter(this,void 0,void 0,function*(){try{return yield this._page.setUserAgent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.121 Safari/537.36"),yield this._page.goto(e,{timeout:12e4,waitUntil:"networkidle2"}),!0}catch(e){throw new ErrorScrapGeolocation_1.default(e)}})}companyInfo(){return __awaiter(this,void 0,void 0,function*(){return yield this._page.waitForSelector("h1",{timeout:1e4}).then(()=>__awaiter(this,void 0,void 0,function*(){return yield this._page.evaluate(()=>{const e={name:"",address:void 0,located_in:void 0,website:void 0,telephone:void 0,plus_code:void 0,ratings:void 0,reviews:void 0};var t;null!=document.querySelector("h1")&&(e.name=document.querySelector("h1").textContent.replace(/\r?\n|\r/g,"").trim());for(const l of document.querySelectorAll(".m6QErb > div > button")){if("address"==l.getAttribute("data-item-id")&&(e.address=l.textContent.replace(/\r?\n|\r/g,"").trim()),"authority"==l.getAttribute("data-item-id")){const s=/^[a-z0-9]+([-.]{1}[a-z0-9]+)*\.[a-z]{2,5}(:[0-9]{1,5})?(\/.*)?$/gm;s.test(l.textContent.replace(/\r?\n|\r/g,"").trim())&&(e.website=l.textContent.replace(/\r?\n|\r/g,"").trim())}!l.getAttribute("data-item-id")||-1==l.getAttribute("data-item-id").indexOf("phone:tel:")||""!=(t=l.textContent.replace(/\r?\n|\r/g,"").replace(/\D/g,"").trim())&&6<t.length&&(e.telephone=t),l.getAttribute("data-item-id")&&"locatedin"==l.getAttribute("data-item-id")&&(e.located_in=l.textContent.replace(/\r?\n|\r/g,"").trim()),l.getAttribute("data-item-id")&&"oloc"==l.getAttribute("data-item-id")&&(e.plus_code=l.textContent.replace(/\r?\n|\r/g,"").trim())}var r=document.querySelectorAll("div[jsaction = 'pane.reviewChart.moreReviews'] tr");if(0<r.length){e.ratings=[];for(const u of r)e.ratings.push(u.getAttribute("aria-label"))}r=document.querySelectorAll("div[jsaction='mouseover:pane.review.in;mouseout:pane.review.out']");if(0<r.length){e.reviews=[];for(const d of r){var i=d.querySelector(".WNxzHc.qLhwHc span")?d.querySelector(".WNxzHc.qLhwHc span").textContent.replace(/\r?\n|\r/g,"").trim():void 0,o=d.querySelector(".RfnDt span:nth-of-type(2)")?d.querySelector(".RfnDt span:last-child").textContent.replace(/\r?\n|\r([^a-zA-Z0-9])/g,"").trim():void 0,a=d.querySelector(".kvMYJc")?d.querySelector(".kvMYJc").getAttribute("aria-label"):void 0,n=d.querySelector(".rsqaWe")?d.querySelector(".rsqaWe").textContent.replace(/\r?\n|\r/g,"").trim():void 0,c=d.querySelector(".wiI7pd")?d.querySelector(".wiI7pd").textContent.replace(/\r?\n|\r/g,"").trim():void 0;e.reviews.push({reviewer_name:i,reviews_amount:o,score:a,date:n,review:c})}}return e})})).catch(e=>{throw new ErrorScrapGeolocation_1.default(e)})})}closePage(){this._page.close()}closeBrowser(){this._browserLauncher.closeBrowser()}}exports.default=ScrapGeolocation;